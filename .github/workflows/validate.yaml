# Validate Aurora Smart Home skill files
# Runs on push and PR to main branch

name: Validate Skills

on:
  push:
    branches: [main]
    paths:
      - 'esphome/**'
      - 'home-assistant/**'
      - 'ha-integration-dev/**'
      - '*.md'
  pull_request:
    branches: [main]
    paths:
      - 'esphome/**'
      - 'home-assistant/**'
      - 'ha-integration-dev/**'
      - '*.md'

jobs:
  validate-yaml:
    name: Validate YAML files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Validate ESPHome templates
        run: |
          echo "Validating ESPHome YAML templates..."
          for file in esphome/assets/templates/*.yaml; do
            echo "Checking $file"
            yamllint -d relaxed "$file" || true
          done

      - name: Validate Home Assistant templates
        run: |
          echo "Validating Home Assistant YAML templates..."
          for file in home-assistant/assets/templates/*.yaml; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              yamllint -d relaxed "$file" || true
            fi
          done

  validate-markdown:
    name: Validate Markdown files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/mlc_config.json'
        continue-on-error: true

      - name: Validate Markdown formatting
        uses: DavidAnson/markdownlint-cli2-action@v14
        with:
          globs: '**/*.md'
        continue-on-error: true

  count-content:
    name: Count skill content
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Count lines of documentation
        run: |
          echo "## Content Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count total lines
          total=$(find . -name "*.md" -type f -exec cat {} \; | wc -l)
          echo "**Total Markdown lines:** $total" >> $GITHUB_STEP_SUMMARY

          # Count YAML templates
          yaml_count=$(find . -name "*.yaml" -path "*/templates/*" | wc -l)
          echo "**YAML templates:** $yaml_count" >> $GITHUB_STEP_SUMMARY

          # Count Python templates
          py_count=$(find . -name "*.py" -path "*/templates/*" | wc -l)
          echo "**Python templates:** $py_count" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Per-Skill Breakdown" >> $GITHUB_STEP_SUMMARY

          for skill in esphome home-assistant ha-integration-dev; do
            if [ -d "$skill" ]; then
              lines=$(find "$skill" -name "*.md" -type f -exec cat {} \; | wc -l)
              refs=$(find "$skill" -path "*/references/*" -name "*.md" | wc -l)
              echo "- **$skill**: $lines lines, $refs reference files" >> $GITHUB_STEP_SUMMARY
            fi
          done

  validate-skill-structure:
    name: Validate skill structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          echo "Checking skill structure..."
          errors=0

          # Check each skill has required files
          for skill in esphome home-assistant ha-integration-dev; do
            if [ -d "$skill" ]; then
              echo "Checking $skill..."

              # Check SKILL.md exists
              if [ ! -f "$skill/SKILL.md" ]; then
                echo "❌ Missing: $skill/SKILL.md"
                errors=$((errors + 1))
              else
                echo "✅ Found: $skill/SKILL.md"
              fi

              # Check README.md exists
              if [ ! -f "$skill/README.md" ]; then
                echo "❌ Missing: $skill/README.md"
                errors=$((errors + 1))
              else
                echo "✅ Found: $skill/README.md"
              fi

              # Check references directory exists
              if [ ! -d "$skill/references" ]; then
                echo "⚠️ Missing: $skill/references/"
              else
                ref_count=$(ls -1 "$skill/references"/*.md 2>/dev/null | wc -l)
                echo "✅ Found: $skill/references/ ($ref_count files)"
              fi
            fi
          done

          if [ $errors -gt 0 ]; then
            echo "Found $errors missing required files"
            exit 1
          fi

      - name: Validate SKILL.md format
        run: |
          echo "Validating SKILL.md format..."

          for skill in esphome home-assistant ha-integration-dev; do
            if [ -f "$skill/SKILL.md" ]; then
              echo "Checking $skill/SKILL.md..."

              # Check for required sections
              if ! grep -q "^name:" "$skill/SKILL.md"; then
                echo "⚠️ Missing 'name:' in $skill/SKILL.md"
              fi

              if ! grep -q "^description:" "$skill/SKILL.md"; then
                echo "⚠️ Missing 'description:' in $skill/SKILL.md"
              fi
            fi
          done

  esphome-validate:
    name: Validate ESPHome configs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install ESPHome
        run: pip install esphome

      - name: Create dummy secrets
        run: |
          cat > esphome/assets/templates/secrets.yaml << 'EOF'
          wifi_ssid: "test_ssid"
          wifi_password: "test_password"
          api_encryption_key: "dGVzdGtleXRlc3RrZXl0ZXN0a2V5dGVzdGtleQ=="
          ota_password: "test_ota_password"
          EOF

      - name: Validate ESPHome templates
        run: |
          cd esphome/assets/templates
          for file in *.yaml; do
            if [ "$file" != "secrets.yaml" ]; then
              echo "Validating $file..."
              esphome config "$file" > /dev/null 2>&1 || echo "⚠️ $file has validation warnings (may need hardware-specific components)"
            fi
          done
        continue-on-error: true
