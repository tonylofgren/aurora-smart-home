# Presence Detection

Guide för pålitlig närvarodetektering i Home Assistant.

## Översikt

Närvarodetektering är grunden för smart hemautomation. En kombination av flera metoder ger bäst resultat.

## Detekteringsmetoder

| Metod | Rum-nivå | Hem-nivå | Fördröjning | Pålitlighet |
|-------|----------|----------|-------------|-------------|
| PIR-sensor | ✅ | ❌ | <1s | Hög (rörelse) |
| mmWave radar | ✅ | ❌ | <1s | Mycket hög |
| BLE | ✅ | ✅ | 1-30s | Medium |
| WiFi tracking | ❌ | ✅ | 1-60s | Medium |
| GPS (mobil) | ❌ | ✅ | 1-5min | Hög (utomhus) |
| Router integration | ❌ | ✅ | 1-5min | Medium |

## Kombinera Metoder

```
┌────────────────────────────────────────────────┐
│              Presence Detection                 │
├────────────────────────────────────────────────┤
│                                                 │
│  Rum-nivå:           Hem-nivå:                 │
│  ┌─────────────┐     ┌──────────────┐          │
│  │ PIR-sensor  │     │ GPS (mobil)  │          │
│  │ mmWave      │     │ WiFi/Router  │          │
│  │ BLE beacon  │     │ BLE proxy    │          │
│  └──────┬──────┘     └──────┬───────┘          │
│         │                   │                   │
│         └─────────┬─────────┘                   │
│                   ↓                             │
│         ┌─────────────────┐                    │
│         │  Bayesian/Group │                    │
│         │    Sensor       │                    │
│         └─────────────────┘                    │
│                   ↓                             │
│              Automationer                       │
└────────────────────────────────────────────────┘
```

## PIR Motion Sensor

Grundläggande rörelsedetektering:

```yaml
# Generated by ha-yaml@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home

automation:
  - alias: "Vardagsrum - Ljus vid rörelse"
    id: living_room_motion_light
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.living_room_motion
        to: "on"
    condition:
      - condition: numeric_state
        entity_id: sensor.living_room_illuminance
        below: 50
    action:
      - service: light.turn_on
        target:
          entity_id: light.living_room
        data:
          brightness_pct: 80
      - wait_for_trigger:
          - platform: state
            entity_id: binary_sensor.living_room_motion
            to: "off"
            for:
              minutes: 5
        timeout:
          minutes: 30
      - service: light.turn_off
        target:
          entity_id: light.living_room
```

## mmWave Radar (Presence, ej rörelse)

Detekterar stillasittande personer:

```yaml
# ESPHome config - se esphome/references/sensors.md

# HA Automation
automation:
  - alias: "Kontor - Ljus vid närvaro"
    id: office_presence_light
    trigger:
      - platform: state
        entity_id: binary_sensor.office_presence_mmwave
        to: "on"
    action:
      - service: light.turn_on
        target:
          entity_id: light.office

  - alias: "Kontor - Släck vid frånvaro"
    id: office_absence_light
    trigger:
      - platform: state
        entity_id: binary_sensor.office_presence_mmwave
        to: "off"
        for:
          minutes: 2  # Kort timeout, mmWave är pålitlig
    action:
      - service: light.turn_off
        target:
          entity_id: light.office
```

## Person Tracker

Kombinera flera device_trackers:

```yaml
# configuration.yaml
person:
  - name: Tony
    id: tony
    device_trackers:
      - device_tracker.tonys_iphone
      - device_tracker.tonys_iphone_ble
      - device_tracker.tony_router
```

## Bayesian Sensor

Kombinera flera signaler med sannolikhet:

```yaml
# configuration.yaml
binary_sensor:
  - platform: bayesian
    name: "Tony Hemma"
    unique_id: tony_home_bayesian
    prior: 0.5  # 50% chans att vara hemma
    probability_threshold: 0.9
    observations:
      # GPS - Hög tillförlitlighet
      - platform: state
        entity_id: person.tony
        to_state: "home"
        prob_given_true: 0.99
        prob_given_false: 0.05

      # WiFi - Medium tillförlitlighet
      - platform: state
        entity_id: device_tracker.tonys_iphone
        to_state: "home"
        prob_given_true: 0.95
        prob_given_false: 0.10

      # BLE - Låg tillförlitlighet (kan missa)
      - platform: state
        entity_id: device_tracker.tonys_iphone_ble
        to_state: "home"
        prob_given_true: 0.80
        prob_given_false: 0.20

      # Router - Medium tillförlitlighet
      - platform: state
        entity_id: device_tracker.tony_router
        to_state: "home"
        prob_given_true: 0.90
        prob_given_false: 0.15
```

## Group Sensor

Enklare alternativ till Bayesian:

```yaml
# configuration.yaml
binary_sensor:
  - platform: group
    name: "Någon Hemma"
    unique_id: anyone_home
    device_class: presence
    entities:
      - person.tony
      - person.anna
    all: false  # Minst en måste vara hemma
```

## Zone-baserad Automation

```yaml
# configuration.yaml
zone:
  - name: Jobbet
    latitude: 59.3293
    longitude: 18.0686
    radius: 100
    icon: mdi:briefcase

  - name: Förskolan
    latitude: 59.3200
    longitude: 18.0750
    radius: 50
    icon: mdi:baby

automation:
  - alias: "Lämnar jobbet - Förvärm huset"
    id: leaving_work_preheat
    trigger:
      - platform: zone
        entity_id: person.tony
        zone: zone.jobbet
        event: leave
    condition:
      - condition: time
        after: "15:00:00"
        before: "19:00:00"
    action:
      - service: climate.set_temperature
        target:
          entity_id: climate.living_room
        data:
          temperature: 22

  - alias: "Alla borta - Energisparläge"
    id: away_mode
    trigger:
      - platform: state
        entity_id: binary_sensor.anyone_home
        to: "off"
        for:
          minutes: 10
    action:
      - service: script.turn_on
        target:
          entity_id: script.away_mode
```

## BLE Room Presence

Detektera i vilket rum någon befinner sig:

```yaml
# Med ESPHome BLE Proxies i varje rum
# Se esphome/references/ble-proxy.md

template:
  - sensor:
      - name: "Tony Rum"
        unique_id: tony_room_location
        state: >
          {% set rooms = {
            'binary_sensor.living_room_tony_ble': 'Vardagsrum',
            'binary_sensor.bedroom_tony_ble': 'Sovrum',
            'binary_sensor.kitchen_tony_ble': 'Kök',
            'binary_sensor.office_tony_ble': 'Kontor'
          } %}
          {% for sensor, room in rooms.items() %}
            {% if is_state(sensor, 'on') %}
              {{ room }}
            {% endif %}
          {% endfor %}
          {% if this.state is undefined %}
            Okänt
          {% endif %}
```

## iPhone Presence (Med Companion App)

```yaml
automation:
  - alias: "Fokusläge - Stör ej aktiv"
    id: focus_mode_active
    trigger:
      - platform: state
        entity_id: sensor.tonys_iphone_focus_mode
        to: "Do Not Disturb"
    action:
      - service: light.turn_off
        target:
          area_id: bedroom

  - alias: "Laddar telefon - Sängdags"
    id: phone_charging_bedtime
    trigger:
      - platform: state
        entity_id: sensor.tonys_iphone_battery_state
        to: "Charging"
    condition:
      - condition: time
        after: "21:00:00"
        before: "06:00:00"
      - condition: zone
        entity_id: person.tony
        zone: zone.home
    action:
      - service: scene.turn_on
        target:
          entity_id: scene.bedtime
```

## Router Integration

### UniFi

```yaml
# configuration.yaml
device_tracker:
  - platform: unifi_direct
    host: !secret unifi_host
    username: !secret unifi_user
    password: !secret unifi_pass
    consider_home: 180  # sekunder
```

### ASUS Router

```yaml
device_tracker:
  - platform: asuswrt
    host: !secret router_ip
    username: !secret router_user
    password: !secret router_pass
    consider_home: 180
```

## Away Mode Automation

Komplett away/home detection:

```yaml
# Generated by ha-yaml@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home

automation:
  # Någon kommer hem
  - alias: "Hem - Välkomstljus"
    id: arriving_home_lights
    trigger:
      - platform: state
        entity_id: binary_sensor.anyone_home
        from: "off"
        to: "on"
    condition:
      - condition: sun
        after: sunset
        after_offset: "-00:30:00"
    action:
      - service: light.turn_on
        target:
          entity_id:
            - light.hallway
            - light.living_room
        data:
          brightness_pct: 80
          transition: 5

  # Alla lämnar
  - alias: "Borta - Stäng av allt"
    id: everyone_left
    trigger:
      - platform: state
        entity_id: binary_sensor.anyone_home
        to: "off"
        for:
          minutes: 15  # Buffer för att undvika falska positives
    action:
      - parallel:
          - service: light.turn_off
            target:
              entity_id: all
          - service: climate.set_preset_mode
            target:
              entity_id: climate.all
            data:
              preset_mode: away
          - service: media_player.turn_off
            target:
              entity_id: all
      # Bekräftelse
      - service: notify.mobile_app_tonys_iphone
        data:
          title: "Huset stängt"
          message: "Alla har lämnat. Energisparläge aktiverat."

  # Lång frånvaro - Extra åtgärder
  - alias: "Borta länge - Semesterläge"
    id: vacation_mode
    trigger:
      - platform: state
        entity_id: binary_sensor.anyone_home
        to: "off"
        for:
          hours: 24
    action:
      - service: water_heater.set_operation_mode
        target:
          entity_id: water_heater.boiler
        data:
          operation_mode: "eco"
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.vacation_mode
```

## Rum-specifik Presence

```yaml
# Generated by ha-yaml@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home

template:
  - binary_sensor:
      - name: "Vardagsrum Upptagen"
        unique_id: living_room_occupied
        device_class: occupancy
        state: >
          {{
            is_state('binary_sensor.living_room_motion', 'on') or
            is_state('binary_sensor.living_room_presence', 'on') or
            is_state('media_player.living_room_tv', 'playing')
          }}
        delay_off:
          minutes: 10

      - name: "Sovrum Upptaget"
        unique_id: bedroom_occupied
        device_class: occupancy
        state: >
          {{
            is_state('binary_sensor.bedroom_motion', 'on') or
            is_state('binary_sensor.bedroom_presence', 'on') or
            (now().hour >= 22 or now().hour < 7)
            and is_state('person.tony', 'home')
          }}
```

## Sleep Detection

```yaml
automation:
  - alias: "Sömn - Detekterad"
    id: sleep_detected
    trigger:
      # iPhone på laddning i sovrummet
      - platform: state
        entity_id: sensor.tonys_iphone_battery_state
        to: "Charging"
      # Fokusläge: Sleep
      - platform: state
        entity_id: sensor.tonys_iphone_focus_mode
        to: "Sleep"
      # Inget ljud i 30 min på kvällen
      - platform: state
        entity_id: binary_sensor.bedroom_presence
        to: "on"
        for:
          minutes: 30
    condition:
      - condition: time
        after: "21:00:00"
        before: "03:00:00"
      - condition: state
        entity_id: person.tony
        state: "home"
    action:
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.tony_sleeping
```

## Felsökning

### Device Tracker Debugging

```yaml
# Developer Tools → States
# Filtrera på device_tracker.*
# Kontrollera source_type och last_seen

logger:
  logs:
    homeassistant.components.device_tracker: debug
    homeassistant.components.mobile_app: debug
```

### Vanliga Problem

| Problem | Orsak | Lösning |
|---------|-------|---------|
| Falska "away" | WiFi sleep | Öka consider_home |
| Långsam detektering | GPS-intervall | Minska intervall i app |
| BLE opålitlig | Signalstyrka | Fler BLE proxies |
| Router missar | DHCP lease | Statiska IP:n |

## Exempelprompts

```
"Skapa en Bayesian sensor som kombinerar GPS och WiFi för presence"

"Jag vill att lamporna tänds när jag kommer hem efter solnedgång"

"Konfigurera room-level presence med mmWave och PIR"

"Detektera när jag går och lägger mig och stäng av allt"

"Skapa en automation som aktiverar semesterläge vid lång frånvaro"
```

## Best Practices

1. **Kombinera metoder** - Använd minst 2-3 olika signaler
2. **Bayesian för hem-nivå** - Sannolikhetsbaserat är mest pålitligt
3. **mmWave för rum-nivå** - Bäst för stillasittande personer
4. **Buffer för away** - Minst 10-15 min innan "away" aktiveras
5. **Notifikationer** - Bekräfta kritiska åtgärder
6. **consider_home** - Öka för opålitliga trackers

## Se även

- `references/automations.md` - Automation patterns
- `references/conditions.md` - Villkor för presence
- `../esphome/references/ble-proxy.md` - BLE presence
- `../esphome/references/sensors.md` - mmWave och PIR
