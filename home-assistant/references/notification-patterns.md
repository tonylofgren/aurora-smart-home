# Notification Patterns

Guide f√∂r att implementera smarta notifikationer i Home Assistant.

## √ñversikt

Bra notifikationer √§r:
- **Relevanta** - Skickas bara n√§r det beh√∂vs
- **Handlingsbara** - Inneh√•ller √•tg√§rder anv√§ndaren kan ta
- **Kontextmedvetna** - Anpassas efter tid, plats och situation
- **Icke-st√∂rande** - Respekterar st√∂r ej-l√§gen

## Notification Platforms

| Platform | Anv√§ndning | √Ötg√§rder | Bilder |
|----------|------------|----------|--------|
| Mobile App | Prim√§r f√∂r personer | ‚úÖ Ja | ‚úÖ Ja |
| Persistent | Dashboard-meddelanden | ‚ùå Nej | ‚ùå Nej |
| TTS | R√∂stmeddelanden | ‚ùå Nej | ‚ùå Nej |
| Email | Rapporter, loggar | ‚ùå Nej | ‚úÖ Ja |
| Telegram | Chat-baserat | ‚úÖ Ja | ‚úÖ Ja |
| Slack/Discord | Team-notifikationer | ‚úÖ Ja | ‚úÖ Ja |

## Mobile App Notifications

### Grundl√§ggande Notifikation

```yaml
# Generated by ha-yaml@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home

automation:
  - alias: "Notifikation - Enkel"
    id: notification_simple
    trigger:
      - platform: state
        entity_id: binary_sensor.front_door
        to: "on"
    action:
      - service: notify.mobile_app_tonys_iphone
        data:
          title: "D√∂rren √∂ppnad"
          message: "Ytterd√∂rren √∂ppnades just"
```

### Med √Ötg√§rdsknappar

```yaml
automation:
  - alias: "Notifikation - Med √•tg√§rder"
    id: notification_with_actions
    trigger:
      - platform: state
        entity_id: binary_sensor.motion_garage
        to: "on"
    condition:
      - condition: state
        entity_id: person.tony
        state: "not_home"
    action:
      - service: notify.mobile_app_tonys_iphone
        data:
          title: "R√∂relse i garaget"
          message: "R√∂relse detekterad medan du √§r borta"
          data:
            actions:
              - action: "VIEW_CAMERA"
                title: "Visa kamera"
                icon: "sfsymbols:camera"
              - action: "ALARM_ON"
                title: "Aktivera larm"
                icon: "sfsymbols:lock.shield"
                destructive: true
              - action: "IGNORE"
                title: "Ignorera"
```

### Hantera √Ötg√§rder

```yaml
automation:
  - alias: "Hantera - Visa kamera"
    id: handle_view_camera
    trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "VIEW_CAMERA"
    action:
      - service: notify.mobile_app_tonys_iphone
        data:
          title: "Garage Kamera"
          message: "Aktuell bild"
          data:
            image: "/api/camera_proxy/camera.garage"

  - alias: "Hantera - Aktivera larm"
    id: handle_alarm_on
    trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "ALARM_ON"
    action:
      - service: alarm_control_panel.alarm_arm_away
        target:
          entity_id: alarm_control_panel.home
```

### Med Kamerabild

```yaml
automation:
  - alias: "Notifikation - Med bild"
    id: notification_with_image
    trigger:
      - platform: state
        entity_id: binary_sensor.doorbell
        to: "on"
    action:
      - service: notify.mobile_app_tonys_iphone
        data:
          title: "N√•gon vid d√∂rren"
          message: "D√∂rrklockan ringde"
          data:
            image: "/api/camera_proxy/camera.doorbell"
            # Eller extern URL:
            # image: "https://example.com/snapshot.jpg"
            actions:
              - action: "UNLOCK_DOOR"
                title: "L√•s upp"
              - action: "URI"
                title: "√ñppna app"
                uri: "/lovelace/cameras"
```

### Kritisk Notifikation

```yaml
automation:
  - alias: "Notifikation - Kritisk"
    id: notification_critical
    trigger:
      - platform: state
        entity_id: binary_sensor.smoke_detector
        to: "on"
    action:
      - service: notify.mobile_app_tonys_iphone
        data:
          title: "‚ö†Ô∏è BRANDLARM"
          message: "R√∂kdetektor aktiverad!"
          data:
            push:
              sound:
                name: "default"
                critical: 1
                volume: 1.0
            # G√•r igenom St√∂r ej
            interruption-level: "critical"
```

### Grupperad Notifikation

```yaml
automation:
  - alias: "Notifikation - Grupperad"
    id: notification_grouped
    trigger:
      - platform: state
        entity_id: binary_sensor.window_open
        to: "on"
    action:
      - service: notify.mobile_app_tonys_iphone
        data:
          title: "F√∂nster √∂ppet"
          message: "{{ trigger.to_state.attributes.friendly_name }}"
          data:
            group: "window-alerts"
            # Alla f√∂nster-notiser grupperas ihop
```

## Kontextmedvetna Notifikationer

### Baserat p√• Hemstatus

```yaml
automation:
  - alias: "Smart notifikation - Hemstatus"
    id: smart_notification_home_status
    trigger:
      - platform: state
        entity_id: binary_sensor.motion_backyard
        to: "on"
    action:
      - choose:
          # Hemma - Inget meddelande
          - conditions:
              - condition: state
                entity_id: binary_sensor.anyone_home
                state: "on"
            sequence: []

          # Borta - Notifikation med √•tg√§rder
          - conditions:
              - condition: state
                entity_id: binary_sensor.anyone_home
                state: "off"
            sequence:
              - service: notify.mobile_app_tonys_iphone
                data:
                  title: "R√∂relse utomhus"
                  message: "R√∂relse p√• baksidan medan du √§r borta"
                  data:
                    actions:
                      - action: "VIEW_CAMERA"
                        title: "Visa kamera"
```

### Baserat p√• Tid

```yaml
automation:
  - alias: "Smart notifikation - Tid"
    id: smart_notification_time
    trigger:
      - platform: state
        entity_id: lock.front_door
        to: "unlocked"
    action:
      - choose:
          # Natt - Kritisk
          - conditions:
              - condition: time
                after: "23:00:00"
                before: "06:00:00"
            sequence:
              - service: notify.mobile_app_tonys_iphone
                data:
                  title: "‚ö†Ô∏è D√∂rren ol√•st"
                  message: "Ytterd√∂rren l√•stes upp mitt i natten!"
                  data:
                    push:
                      sound:
                        critical: 1

          # Dag - Normal
          - conditions:
              - condition: time
                after: "06:00:00"
                before: "23:00:00"
            sequence:
              - service: notify.mobile_app_tonys_iphone
                data:
                  title: "D√∂rr ol√•st"
                  message: "Ytterd√∂rren l√•stes upp"
```

### Baserat p√• Fokusl√§ge (iPhone)

```yaml
automation:
  - alias: "Respektera fokusl√§ge"
    id: respect_focus_mode
    trigger:
      - platform: state
        entity_id: sensor.motion_living_room
        to: "on"
    condition:
      # Skicka bara om inte i St√∂r ej
      - condition: not
        conditions:
          - condition: state
            entity_id: sensor.tonys_iphone_focus_mode
            state: "Do Not Disturb"
    action:
      - service: notify.mobile_app_tonys_iphone
        data:
          message: "R√∂relse i vardagsrummet"
```

## Notification Groups

Skicka till flera enheter:

```yaml
# configuration.yaml
notify:
  - platform: group
    name: all_phones
    services:
      - service: mobile_app_tonys_iphone
      - service: mobile_app_annas_iphone

  - platform: group
    name: adults
    services:
      - service: mobile_app_tonys_iphone
      - service: mobile_app_annas_iphone

  - platform: group
    name: parents
    services:
      - service: mobile_app_tonys_iphone
      - service: mobile_app_annas_iphone
```

```yaml
automation:
  - alias: "Notifiera alla"
    trigger:
      # ...
    action:
      - service: notify.all_phones
        data:
          title: "Meddelande till alla"
          message: "Detta g√•r till alla telefoner"
```

## Persistent Notifications

Dashboard-meddelanden:

```yaml
automation:
  - alias: "Persistent - Uppdatering tillg√§nglig"
    id: persistent_update_available
    trigger:
      - platform: state
        entity_id: update.home_assistant_core_update
        to: "on"
    action:
      - service: persistent_notification.create
        data:
          title: "Uppdatering tillg√§nglig"
          message: >
            Home Assistant {{ state_attr('update.home_assistant_core_update', 'latest_version') }}
            √§r tillg√§nglig. Du k√∂r {{ state_attr('update.home_assistant_core_update', 'installed_version') }}.
          notification_id: "ha_update"

  # Ta bort n√§r uppdaterad
  - alias: "Persistent - Ta bort uppdateringsnotis"
    id: persistent_remove_update
    trigger:
      - platform: state
        entity_id: update.home_assistant_core_update
        to: "off"
    action:
      - service: persistent_notification.dismiss
        data:
          notification_id: "ha_update"
```

## TTS Notifications

R√∂stmeddelanden:

```yaml
automation:
  - alias: "TTS - V√§lkommen hem"
    id: tts_welcome_home
    trigger:
      - platform: state
        entity_id: person.tony
        to: "home"
    condition:
      - condition: time
        after: "08:00:00"
        before: "22:00:00"
    action:
      - service: tts.speak
        target:
          entity_id: tts.piper
        data:
          media_player_entity_id: media_player.living_room_speaker
          message: >
            V√§lkommen hem Tony.
            {% if states('sensor.outdoor_temperature') | float < 0 %}
              Det √§r {{ states('sensor.outdoor_temperature') }} grader ute, kl√§ dig varmt.
            {% endif %}
```

## Sammanfattningsnotifikationer

Daglig sammanfattning:

```yaml
automation:
  - alias: "Daglig sammanfattning"
    id: daily_summary
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: state
        entity_id: binary_sensor.workday_sensor
        state: "on"
    action:
      - service: notify.mobile_app_tonys_iphone
        data:
          title: "‚òÄÔ∏è God morgon"
          message: >
            V√§der: {{ states('weather.home') }}, {{ state_attr('weather.home', 'temperature') }}¬∞C

            {% set lights = states.light | selectattr('state', 'eq', 'on') | list | count %}
            üí° {{ lights }} lampor t√§nda

            {% set open_windows = states.binary_sensor
              | selectattr('attributes.device_class', 'eq', 'window')
              | selectattr('state', 'eq', 'on')
              | list | count %}
            {% if open_windows > 0 %}
            ü™ü {{ open_windows }} f√∂nster √∂ppna
            {% endif %}

            {% set battery_low = states.sensor
              | selectattr('attributes.device_class', 'eq', 'battery')
              | selectattr('state', 'lt', '20')
              | list %}
            {% if battery_low | count > 0 %}
            üîã L√•gt batteri: {{ battery_low | map(attribute='name') | join(', ') }}
            {% endif %}
```

## Rate Limiting

Undvik notifikationsspam:

```yaml
automation:
  - alias: "Rate limited notification"
    id: rate_limited_notification
    trigger:
      - platform: state
        entity_id: binary_sensor.motion
        to: "on"
    condition:
      # Max en notifikation per 5 minuter
      - condition: template
        value_template: >
          {{ (as_timestamp(now()) - as_timestamp(
              state_attr('automation.rate_limited_notification', 'last_triggered') or 0
          )) > 300 }}
    action:
      - service: notify.mobile_app_tonys_iphone
        data:
          message: "R√∂relse detekterad"
```

Eller med input_datetime:

```yaml
# Hj√§lpare
input_datetime:
  last_motion_notification:
    has_date: true
    has_time: true

automation:
  - alias: "Rate limited med hj√§lpare"
    id: rate_limited_helper
    trigger:
      - platform: state
        entity_id: binary_sensor.motion
        to: "on"
    condition:
      - condition: template
        value_template: >
          {{ (now() - states('input_datetime.last_motion_notification') | as_datetime).total_seconds() > 300 }}
    action:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_motion_notification
        data:
          datetime: "{{ now().isoformat() }}"
      - service: notify.mobile_app_tonys_iphone
        data:
          message: "R√∂relse detekterad"
```

## Escalating Notifications

Eskalera om ingen svarar:

```yaml
automation:
  - alias: "Eskalerande notifikation"
    id: escalating_notification
    trigger:
      - platform: state
        entity_id: binary_sensor.water_leak
        to: "on"
    action:
      # Steg 1: Normal notifikation
      - service: notify.mobile_app_tonys_iphone
        data:
          title: "Vattenl√§cka"
          message: "L√§cka detekterad!"
          data:
            tag: "water_leak"
            actions:
              - action: "LEAK_HANDLED"
                title: "Hanterad"

      # V√§nta 5 minuter
      - wait_for_trigger:
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "LEAK_HANDLED"
        timeout:
          minutes: 5

      # Steg 2: Kritisk om ingen svarade
      - if:
          - condition: template
            value_template: "{{ wait.trigger is none }}"
        then:
          - service: notify.all_phones
            data:
              title: "‚ö†Ô∏è VATTENL√ÑCKA - EJ BEKR√ÑFTAD"
              message: "L√§cka fortfarande aktiv!"
              data:
                push:
                  sound:
                    critical: 1
                actions:
                  - action: "LEAK_HANDLED"
                    title: "Hanterad"

      # Steg 3: Automatisk avst√§ngning
      - wait_for_trigger:
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "LEAK_HANDLED"
        timeout:
          minutes: 5

      - if:
          - condition: template
            value_template: "{{ wait.trigger is none }}"
        then:
          - service: switch.turn_off
            target:
              entity_id: switch.water_main
          - service: notify.all_phones
            data:
              title: "Vatten avst√§ngt"
              message: "Vattenf√∂rs√∂rjningen st√§ngdes av automatiskt"
```

## Exempelprompts

```
"Skapa en notifikation med kamerabild n√§r d√∂rrklockan ringer"

"Jag vill ha actionable notifications f√∂r garager√∂relse"

"Konfigurera en daglig sammanfattning varje morgon"

"Implementera eskalerande notifikationer f√∂r brandlarm"

"Skapa rate-limited notifications f√∂r r√∂relsesensor"
```

## Best Practices

1. **Anv√§nd grupper** - `notify.all_phones` ist√§llet f√∂r flera tj√§nster
2. **Tagga notifikationer** - F√∂r att kunna uppdatera/ta bort
3. **Rate limit** - Undvik notifikationsspam
4. **Respektera fokusl√§gen** - Kontrollera innan icke-kritiska notis
5. **Eskalera viktigt** - Kritiska h√§ndelser kr√§ver bekr√§ftelse
6. **Gruppera relaterade** - Anv√§nd `group` f√∂r att samla liknande
7. **Actionable** - L√§gg till knappar f√∂r vanliga √•tg√§rder

## Se √§ven

- `references/automations.md` - Automation patterns
- `references/jinja2-templates.md` - Dynamiska meddelanden
- `references/presence-detection.md` - Kontextmedvetenhet
