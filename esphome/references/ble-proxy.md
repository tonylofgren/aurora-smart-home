# BLE Proxy

Guide för att konfigurera ESP32 som Bluetooth Low Energy (BLE) proxy för Home Assistant.

## Översikt

BLE Proxy utökar Home Assistants Bluetooth-räckvidd genom att placera ESP32-enheter strategiskt i hemmet. Varje proxy vidarebefordrar BLE-annonsering till Home Assistant via ESPHome API.

## Användningsområden

- **Xiaomi/Mijia sensorer** - Temperatur, luftfuktighet, växter
- **iBeacons** - Närvarodetektering
- **Tile/AirTag** - Spårning
- **Bluetooth-termometrar** - Kök, grill, pool
- **BLE-lås** - Smart locks

## Hårdvarukrav

| Chip | BLE Proxy | Active Connections | Rekommendation |
|------|-----------|-------------------|----------------|
| ESP32 | ✅ Ja | 3 | Standard, billig |
| ESP32-S3 | ✅ Ja | 9 | Bättre prestanda |
| ESP32-C3 | ✅ Ja | 3 | Kompakt |
| ESP32-C6 | ✅ Ja | 3 | Thread + BLE |
| ESP8266 | ❌ Nej | - | Saknar BLE |

## Minimal BLE Proxy

```yaml
# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home

esphome:
  name: ble-proxy-living-room
  friendly_name: "BLE Proxy Vardagsrum"

esp32:
  board: esp32dev
  framework:
    type: esp-idf  # Rekommenderas för BLE

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

api:

ota:
  platform: esphome

logger:

# BLE Proxy - Vidarebefordrar till Home Assistant
esp32_ble_tracker:
  scan_parameters:
    active: true
    interval: 1100ms
    window: 1100ms

bluetooth_proxy:
  active: true  # Tillåter aktiva anslutningar
```

## Optimerad BLE Proxy

```yaml
# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home

esphome:
  name: ble-proxy-optimized
  friendly_name: "BLE Proxy Optimerad"

esp32:
  board: esp32dev
  framework:
    type: esp-idf

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  # Statisk IP för stabilitet
  manual_ip:
    static_ip: 192.168.1.50
    gateway: 192.168.1.1
    subnet: 255.255.255.0

api:
  encryption:
    key: !secret api_encryption_key

ota:
  platform: esphome
  password: !secret ota_password

logger:
  level: WARN  # Minska loggning för prestanda

# Optimerade BLE-inställningar
esp32_ble_tracker:
  scan_parameters:
    active: true
    interval: 1100ms
    window: 1100ms
    continuous: true

bluetooth_proxy:
  active: true
  cache_services: true  # Cachar GATT-tjänster
```

## BLE Proxy med lokala sensorer

Kombinera proxy med lokala Bluetooth-sensorer:

```yaml
# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home

esphome:
  name: ble-proxy-with-sensors
  friendly_name: "BLE Proxy med Sensorer"

esp32:
  board: esp32dev
  framework:
    type: esp-idf

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

api:
ota:
  platform: esphome
logger:

esp32_ble_tracker:
  scan_parameters:
    active: true

bluetooth_proxy:
  active: true

# Xiaomi LYWSD03MMC (custom firmware)
sensor:
  - platform: xiaomi_lywsd03mmc
    mac_address: "A4:C1:38:XX:XX:XX"
    bindkey: "YOUR_BIND_KEY"
    temperature:
      name: "Sovrum Temperatur"
    humidity:
      name: "Sovrum Luftfuktighet"
    battery_level:
      name: "Sovrum Sensor Batteri"

  # Xiaomi Mi Flora (växtsensor)
  - platform: xiaomi_hhccjcy01
    mac_address: "C4:7C:8D:XX:XX:XX"
    temperature:
      name: "Växt Temperatur"
    moisture:
      name: "Växt Jordfuktighet"
    illuminance:
      name: "Växt Ljus"
    conductivity:
      name: "Växt Ledningsförmåga"
    battery_level:
      name: "Växt Sensor Batteri"
```

## BLE Presence Detection

Detektera närvaro via BLE-enheter (telefoner, smartklockor):

```yaml
# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home

esphome:
  name: ble-presence
  friendly_name: "BLE Presence"

esp32:
  board: esp32dev
  framework:
    type: esp-idf

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

api:
ota:
  platform: esphome
logger:

esp32_ble_tracker:
  scan_parameters:
    active: false  # Passiv scanning räcker
    interval: 1100ms
    window: 1100ms

bluetooth_proxy:
  active: false  # Bara tracking

# iBeacon presence
binary_sensor:
  - platform: ble_presence
    ibeacon_uuid: "YOUR-IBEACON-UUID"
    name: "iPhone Hemma"

  # MAC-baserad (mindre tillförlitlig)
  - platform: ble_presence
    mac_address: "AA:BB:CC:DD:EE:FF"
    name: "Smartklocka Hemma"
    timeout: 5min

# RSSI för avstånd
sensor:
  - platform: ble_rssi
    mac_address: "AA:BB:CC:DD:EE:FF"
    name: "Telefon RSSI"
    filters:
      - exponential_moving_average:
          alpha: 0.3
          send_every: 1
```

## Flera BLE Proxies

Vid stor bostad, placera flera proxies:

```
┌─────────────────────────────────────────┐
│                 Hem                      │
│                                          │
│  ┌─────┐        ┌─────┐        ┌─────┐  │
│  │ BLE │        │ BLE │        │ BLE │  │
│  │Proxy│        │Proxy│        │Proxy│  │
│  │ #1  │        │ #2  │        │ #3  │  │
│  └──┬──┘        └──┬──┘        └──┬──┘  │
│     │              │              │      │
│     └──────────────┼──────────────┘      │
│                    │                     │
│              ┌─────┴─────┐               │
│              │   Home    │               │
│              │ Assistant │               │
│              └───────────┘               │
└─────────────────────────────────────────┘
```

**Namnkonvention:**
- `ble-proxy-living-room`
- `ble-proxy-bedroom`
- `ble-proxy-garage`

## ESP-IDF vs Arduino Framework

| Feature | Arduino | ESP-IDF |
|---------|---------|---------|
| BLE Stability | Bra | Mycket bra |
| Active Connections | 3 | 3-9 (chip-beroende) |
| Memory Usage | Högre | Lägre |
| Compilation Time | Snabbare | Långsammare |
| Rekommendation | Enkla projekt | BLE Proxy |

**Använd ESP-IDF för BLE Proxy:**
```yaml
esp32:
  board: esp32dev
  framework:
    type: esp-idf
```

## Scan Parameters

| Parameter | Värde | Beskrivning |
|-----------|-------|-------------|
| `interval` | 1100ms | Tid mellan skanningar |
| `window` | 1100ms | Tid per skanning |
| `active` | true/false | Aktivt frågande |
| `continuous` | true/false | Kontinuerlig skanning |

**Tumregler:**
- `window` ≤ `interval`
- `window = interval` för maximal täckning
- `active: true` för enheter som kräver det
- `continuous: true` för presence detection

## Felsökning

### Enhet syns inte

1. **Kontrollera MAC-adress** - Bekräfta med nRF Connect app
2. **Aktivera active scanning** - Vissa enheter kräver det
3. **Öka window** - Längre skanningsperiod
4. **Kontrollera räckvidd** - BLE har ~10m räckvidd

### Instabil anslutning

1. **Använd ESP-IDF** framework
2. **Minska antal aktiva anslutningar**
3. **Öka scan interval**
4. **Kontrollera WiFi-störningar** (2.4GHz)

### Hög CPU/minnesanvändning

```yaml
esp32_ble_tracker:
  scan_parameters:
    active: false  # Passiv om möjligt
    interval: 2000ms  # Öka intervall
    window: 1000ms
```

## Home Assistant Integration

BLE Proxy integreras automatiskt:

1. **Installera ESPHome integration** i HA
2. **Adopera enheten** när den upptäcks
3. **BLE-enheter visas** under Integrations → Bluetooth

**Ingen extra konfiguration behövs** - Home Assistant ser alla BLE-enheter via proxyn.

## Exempelprompts

```
"Konfigurera ESP32 som BLE proxy för mina Xiaomi-sensorer"

"Jag vill ha presence detection med iBeacon och ESP32"

"Skapa en BLE proxy med Xiaomi Mi Flora växtsensor"

"Optimera min BLE proxy för bättre räckvidd och stabilitet"

"Konfigurera flera BLE proxies för mitt tvåvåningshus"
```

## Se även

- `references/bluetooth.md` - Allmän Bluetooth-konfiguration
- `references/sensors.md` - Sensorplattformar
- `references/power-management.md` - Batteridrivna enheter
