# Matter Bridge

Guide för att exponera ESPHome-enheter till Matter-ekosystemet.

## Översikt

Matter är en universell smart home-standard som stöds av Apple, Google, Amazon och Samsung. Med ESPHome kan du:

- Exponera ESPHome-enheter direkt till Matter
- Använda ESP32 som Matter-brygga
- Styra enheter via Apple Home, Google Home, Amazon Alexa samtidigt

## Hårdvarukrav

| Chip | Matter Support | Thread | Rekommendation |
|------|----------------|--------|----------------|
| ESP32 | ✅ WiFi | ❌ | Budget, bara WiFi |
| ESP32-S3 | ✅ WiFi | ❌ | Mer minne |
| ESP32-C3 | ✅ WiFi | ❌ | Kompakt |
| ESP32-C6 | ✅ WiFi + Thread | ✅ | Bäst för Matter |
| ESP32-H2 | ❌ (ingen WiFi) | ✅ | Bara Thread |

**ESP32-C6 rekommenderas** för Matter då den stöder både WiFi och Thread.

## Aktivera Matter

```yaml
# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home

esphome:
  name: matter-light
  friendly_name: "Matter Lampa"

esp32:
  board: esp32-c6-devkitc-1
  framework:
    type: esp-idf
    version: "5.1.2"
    sdkconfig_options:
      CONFIG_ENABLE_MATTER: y

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

# Matter aktiveras här
matter:
  # Enhetstyp - se lista nedan
  device_type: light

api:
  # API behövs fortfarande för ESPHome Dashboard

ota:
  platform: esphome

logger:
```

## Matter Device Types

| Device Type | Beskrivning | Entiteter |
|-------------|-------------|-----------|
| `light` | Lampa | light |
| `dimmable_light` | Dimbar lampa | light (brightness) |
| `color_temperature_light` | Varmvit-kallvit | light (color_temp) |
| `extended_color_light` | RGB/RGBW | light (rgb) |
| `on_off_plug` | Enkel switch | switch |
| `dimmable_plug` | Dimbar kontakt | switch (brightness) |
| `temperature_sensor` | Temperatur | sensor |
| `humidity_sensor` | Luftfuktighet | sensor |
| `contact_sensor` | Dörr/fönster | binary_sensor |
| `occupancy_sensor` | Rörelse | binary_sensor |
| `lock` | Lås | lock |
| `thermostat` | Termostat | climate |
| `fan` | Fläkt | fan |
| `cover` | Gardin/rullgardin | cover |

## Grundläggande Lampa

```yaml
# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home

esphome:
  name: matter-light-bulb
  friendly_name: "Matter Glödlampa"

esp32:
  board: esp32-c6-devkitc-1
  framework:
    type: esp-idf

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

matter:
  device_type: dimmable_light

api:
ota:
  platform: esphome
logger:

# PWM output för dimning
output:
  - platform: ledc
    pin: GPIO8
    id: light_output

light:
  - platform: monochromatic
    name: "Lampa"
    output: light_output
    # Denna light exponeras automatiskt till Matter
```

## RGB Lampa

```yaml
# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home

esphome:
  name: matter-rgb-light
  friendly_name: "Matter RGB Lampa"

esp32:
  board: esp32-c6-devkitc-1
  framework:
    type: esp-idf

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

matter:
  device_type: extended_color_light

api:
ota:
  platform: esphome
logger:

output:
  - platform: ledc
    pin: GPIO4
    id: red_output
  - platform: ledc
    pin: GPIO5
    id: green_output
  - platform: ledc
    pin: GPIO6
    id: blue_output

light:
  - platform: rgb
    name: "RGB Lampa"
    red: red_output
    green: green_output
    blue: blue_output
```

## Smart Plug

```yaml
# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home

esphome:
  name: matter-plug
  friendly_name: "Matter Kontakt"

esp32:
  board: esp32-c6-devkitc-1
  framework:
    type: esp-idf

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

matter:
  device_type: on_off_plug

api:
ota:
  platform: esphome
logger:

switch:
  - platform: gpio
    pin: GPIO10
    name: "Kontakt"
    id: relay
```

## Temperatur & Luftfuktighet

```yaml
# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home

esphome:
  name: matter-sensor
  friendly_name: "Matter Sensor"

esp32:
  board: esp32-c6-devkitc-1
  framework:
    type: esp-idf

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

matter:
  device_type: temperature_sensor
  # Notera: Matter stöder bara en device_type per enhet
  # För kombinerad temp/humidity behövs aggregator pattern

api:
ota:
  platform: esphome
logger:

i2c:
  sda: GPIO6
  scl: GPIO7

sensor:
  - platform: sht3xd
    temperature:
      name: "Temperatur"
    humidity:
      name: "Luftfuktighet"
    update_interval: 60s
```

## Rörelsesensor

```yaml
# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home

esphome:
  name: matter-motion
  friendly_name: "Matter Rörelse"

esp32:
  board: esp32-c6-devkitc-1
  framework:
    type: esp-idf

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

matter:
  device_type: occupancy_sensor

api:
ota:
  platform: esphome
logger:

binary_sensor:
  - platform: gpio
    pin:
      number: GPIO4
      mode: INPUT_PULLDOWN
    name: "Rörelse"
    device_class: motion
```

## Dörrsensor

```yaml
# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home

esphome:
  name: matter-door
  friendly_name: "Matter Dörr"

esp32:
  board: esp32-c6-devkitc-1
  framework:
    type: esp-idf

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

matter:
  device_type: contact_sensor

api:
ota:
  platform: esphome
logger:

binary_sensor:
  - platform: gpio
    pin:
      number: GPIO4
      mode: INPUT_PULLUP
      inverted: true
    name: "Dörr"
    device_class: door
```

## Thread Support (ESP32-C6)

```yaml
# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home

esphome:
  name: matter-thread-light
  friendly_name: "Matter Thread Lampa"

esp32:
  board: esp32-c6-devkitc-1
  framework:
    type: esp-idf
    version: "5.1.2"
    sdkconfig_options:
      CONFIG_OPENTHREAD_ENABLED: y
      CONFIG_ENABLE_MATTER: y

# Thread istället för WiFi
thread:
  # Thread credentials hämtas från Thread Border Router
  # (Apple HomePod, Google Nest, etc.)

matter:
  device_type: dimmable_light

api:
ota:
  platform: esphome
logger:

output:
  - platform: ledc
    pin: GPIO8
    id: light_output

light:
  - platform: monochromatic
    name: "Lampa"
    output: light_output
```

## Pairing Process

### QR-kod Generering

ESPHome genererar automatiskt en QR-kod vid kompilering. Den visas i:
1. ESPHome Dashboard logs
2. Enhetens webbgränssnitt

### Manual Pairing Code

```yaml
matter:
  device_type: light
  # Custom pairing code (valfritt)
  discriminator: 3840
  passcode: 20202021
```

### Pairing via Apple Home

1. Öppna Apple Home app
2. Tryck "+" → "Add Accessory"
3. Skanna QR-koden från ESPHome

### Pairing via Google Home

1. Öppna Google Home app
2. "+" → "Set up device" → "Works with Google"
3. Välj "Matter" och skanna QR-koden

### Pairing via Amazon Alexa

1. Öppna Alexa app
2. "Devices" → "+" → "Add Device"
3. Välj "Matter" och skanna QR-koden

## Multi-Admin (Multi-Fabric)

Matter stöder att samma enhet paras med flera ekosystem:

```
┌─────────────────────────────────────────────┐
│           ESPHome Matter Device              │
├─────────────────────────────────────────────┤
│                                              │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐  │
│  │Apple Home │ │Google Home│ │Amazon Echo│  │
│  │  Fabric   │ │  Fabric   │ │  Fabric   │  │
│  └───────────┘ └───────────┘ └───────────┘  │
│                                              │
└─────────────────────────────────────────────┘
```

För att para med ytterligare ekosystem:
1. Öppna första ekosystemets app
2. Hitta "Share device" eller "Turn on pairing mode"
3. Skanna med nästa ekosystems app

## Begränsningar

| Begränsning | Beskrivning |
|-------------|-------------|
| En device_type | Varje ESPHome-enhet kan bara ha en Matter device type |
| Minne | Matter kräver mycket flash/RAM - använd ESP32-C6 eller bättre |
| Thread | Bara ESP32-C6 och ESP32-H2 stöder Thread |
| Beta | ESPHome Matter är fortfarande experimentellt |

## Felsökning

### Enheten syns inte

1. **Kontrollera logs** - Matter pairing info visas i ESPHome logs
2. **Samma nätverk** - Telefon och ESP måste vara på samma WiFi
3. **Router multicast** - Vissa routers blockerar mDNS/multicast

### Pairing misslyckas

1. **Factory reset** - Ta bort och lägg till på nytt i ESPHome
2. **Uppdatera firmware** - Senaste ESPHome version
3. **Kontrollera QR-kod** - Generera ny om gammal

### Instabil anslutning

```yaml
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  # Fast connect för stabilitet
  fast_connect: true
  # Statisk IP rekommenderas
  manual_ip:
    static_ip: 192.168.1.100
    gateway: 192.168.1.1
    subnet: 255.255.255.0
```

## Framtida Utveckling

Matter i ESPHome är under aktiv utveckling. Kommande funktioner:

- Aggregator device type (flera sensorer i en enhet)
- Bridged devices (brygga till icke-Matter enheter)
- Bättre Thread-stöd
- Fler device types

## Exempelprompts

```
"Konfigurera en ESP32-C6 som Matter-lampa för Apple Home"

"Jag vill ha en rörelsesensor som fungerar med både Google och Apple"

"Skapa en Matter-kontakt med energimätning"

"Hur parar jag samma Matter-enhet med flera ekosystem?"

"Konfigurera Thread på ESP32-C6 för Matter"
```

## Se även

- `references/lights.md` - Lampkonfiguration
- `references/sensors.md` - Sensorer
- `references/bluetooth.md` - BLE (alternativ för Apple)
- `../home-assistant/references/integrations-matter.md` - HA Matter integration
