# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# E-Ink Dashboard Display
# -----------------------
# Low-power e-ink display for wall-mounted dashboards:
# - Weather information
# - Calendar events
# - Sensor readings
# - Battery-friendly (updates every few minutes)
#
# Hardware:
#   - ESP32 (any variant)
#   - E-ink display: Waveshare 2.9", 4.2", or 7.5"
#   - Optional: Deep sleep for battery operation
#
# Supported displays:
#   - 2.9" (296x128) - Small info display
#   - 4.2" (400x300) - Medium dashboard
#   - 7.5" (800x480) - Large wall display

substitutions:
  device_name: "eink-dashboard"
  friendly_name: "E-Ink Dashboard"
  room_name: "Hallway"

  # SPI pins (standard ESP32)
  clk_pin: "GPIO18"
  mosi_pin: "GPIO23"
  cs_pin: "GPIO5"
  dc_pin: "GPIO17"
  reset_pin: "GPIO16"
  busy_pin: "GPIO4"

  # Update interval (e-ink is slow, don't update too often)
  update_interval: "5min"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}

esp32:
  board: esp32dev
  framework:
    type: arduino

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  ap:
    ssid: "${device_name}-fallback"

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

logger:
  level: INFO

# =============================================================================
# Home Assistant Sensors (import from HA)
# =============================================================================

text_sensor:
  # Weather condition from HA
  - platform: homeassistant
    id: weather_condition
    entity_id: weather.home
    attribute: condition

  # Today's calendar event
  - platform: homeassistant
    id: calendar_event
    entity_id: calendar.family
    attribute: message

  - platform: version
    name: "${friendly_name} ESPHome Version"
    entity_category: diagnostic

sensor:
  # Outside temperature from HA
  - platform: homeassistant
    id: outside_temp
    entity_id: weather.home
    attribute: temperature

  # Inside temperature from HA
  - platform: homeassistant
    id: inside_temp
    entity_id: sensor.living_room_temperature

  # Humidity from HA
  - platform: homeassistant
    id: inside_humidity
    entity_id: sensor.living_room_humidity

  - platform: wifi_signal
    name: "${friendly_name} WiFi"
    update_interval: 60s
    entity_category: diagnostic

# =============================================================================
# Time (for display)
# =============================================================================

time:
  - platform: homeassistant
    id: ha_time

# =============================================================================
# SPI Bus
# =============================================================================

spi:
  clk_pin: ${clk_pin}
  mosi_pin: ${mosi_pin}

# =============================================================================
# Fonts
# =============================================================================

font:
  # Large font for time
  - file: "gfonts://Roboto"
    id: font_large
    size: 48

  # Medium font for weather
  - file: "gfonts://Roboto"
    id: font_medium
    size: 24

  # Small font for details
  - file: "gfonts://Roboto"
    id: font_small
    size: 16

  # Icons (Material Design Icons)
  - file: "gfonts://Material+Symbols+Outlined"
    id: font_icons
    size: 32
    glyphs:
      - "\U000F0590"  # thermometer
      - "\U000F058E"  # water-percent (humidity)
      - "\U000F0599"  # weather-sunny
      - "\U000F0595"  # weather-cloudy
      - "\U000F0597"  # weather-rainy
      - "\U000F0598"  # weather-snowy
      - "\U000F0596"  # weather-partly-cloudy

# =============================================================================
# E-Ink Display (4.2" Waveshare example)
# =============================================================================

display:
  - platform: waveshare_epaper
    id: eink_display
    cs_pin: ${cs_pin}
    dc_pin: ${dc_pin}
    reset_pin: ${reset_pin}
    busy_pin: ${busy_pin}
    model: 4.20in
    update_interval: ${update_interval}
    rotation: 0
    full_update_every: 30  # Full refresh every 30 partial updates
    lambda: |-
      // Screen dimensions: 400x300 for 4.2"
      int w = it.get_width();
      int h = it.get_height();

      // Draw border
      it.rectangle(0, 0, w, h);

      // === TIME (top center) ===
      auto time = id(ha_time).now();
      if (time.is_valid()) {
        it.printf(w/2, 20, id(font_large), TextAlign::TOP_CENTER,
                  "%02d:%02d", time.hour, time.minute);

        // Date below time
        it.printf(w/2, 75, id(font_small), TextAlign::TOP_CENTER,
                  "%s %d %s",
                  time.strftime("%A").c_str(),
                  time.day_of_month,
                  time.strftime("%B").c_str());
      }

      // === Divider line ===
      it.line(20, 100, w-20, 100);

      // === WEATHER (left side) ===
      // Outside temperature
      if (!isnan(id(outside_temp).state)) {
        it.printf(30, 120, id(font_medium), TextAlign::TOP_LEFT,
                  "Out: %.0f째C", id(outside_temp).state);
      }

      // Inside temperature
      if (!isnan(id(inside_temp).state)) {
        it.printf(30, 150, id(font_medium), TextAlign::TOP_LEFT,
                  "In: %.1f째C", id(inside_temp).state);
      }

      // Humidity
      if (!isnan(id(inside_humidity).state)) {
        it.printf(30, 180, id(font_small), TextAlign::TOP_LEFT,
                  "Humidity: %.0f%%", id(inside_humidity).state);
      }

      // Weather condition
      if (id(weather_condition).has_state()) {
        it.printf(30, 210, id(font_small), TextAlign::TOP_LEFT,
                  "%s", id(weather_condition).state.c_str());
      }

      // === CALENDAR (right side) ===
      it.printf(w-30, 120, id(font_small), TextAlign::TOP_RIGHT, "Today:");
      if (id(calendar_event).has_state() && id(calendar_event).state.length() > 0) {
        // Truncate long event names
        std::string event = id(calendar_event).state;
        if (event.length() > 20) {
          event = event.substr(0, 17) + "...";
        }
        it.printf(w-30, 145, id(font_small), TextAlign::TOP_RIGHT,
                  "%s", event.c_str());
      } else {
        it.printf(w-30, 145, id(font_small), TextAlign::TOP_RIGHT,
                  "No events");
      }

      // === Footer (last update) ===
      it.line(20, h-40, w-20, h-40);
      if (time.is_valid()) {
        it.printf(w/2, h-30, id(font_small), TextAlign::TOP_CENTER,
                  "Updated: %02d:%02d", time.hour, time.minute);
      }

# =============================================================================
# Alternative: 2.9" Display (296x128)
# =============================================================================

# Uncomment for smaller display:
# display:
#   - platform: waveshare_epaper
#     model: 2.90in
#     cs_pin: ${cs_pin}
#     dc_pin: ${dc_pin}
#     reset_pin: ${reset_pin}
#     busy_pin: ${busy_pin}
#     update_interval: ${update_interval}
#     lambda: |-
#       // Compact layout for 296x128
#       auto time = id(ha_time).now();
#       if (time.is_valid()) {
#         it.printf(0, 0, id(font_large), "%02d:%02d", time.hour, time.minute);
#       }
#       if (!isnan(id(inside_temp).state)) {
#         it.printf(0, 60, id(font_medium), "%.1f째C", id(inside_temp).state);
#       }
#       if (!isnan(id(outside_temp).state)) {
#         it.printf(0, 90, id(font_small), "Out: %.0f째C", id(outside_temp).state);
#       }

# =============================================================================
# Manual Refresh Button
# =============================================================================

button:
  - platform: template
    name: "${friendly_name} Refresh"
    icon: "mdi:refresh"
    on_press:
      - component.update: eink_display

  - platform: restart
    name: "${friendly_name} Restart"
    entity_category: config

# =============================================================================
# Binary Sensors
# =============================================================================

binary_sensor:
  - platform: status
    name: "${friendly_name} Status"

# =============================================================================
# Deep Sleep (for battery operation)
# =============================================================================

# Uncomment for battery-powered operation:
# deep_sleep:
#   run_duration: 30s
#   sleep_duration: 5min
