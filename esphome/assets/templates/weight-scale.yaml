# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# Digital Weight Scale
# --------------------
# Precision weight measurement using load cells:
# - High accuracy (0.1g possible)
# - Tare function
# - Multiple unit support (g, kg, lb, oz)
# - Calibration via Home Assistant
#
# Hardware:
#   - ESP32 or ESP8266
#   - HX711 ADC (24-bit)
#   - Load cell (1kg, 5kg, 10kg, 50kg options)
#   - Optional: OLED display, buttons
#
# Applications: Kitchen scale, bee hive, pet feeder, packages

substitutions:
  device_name: "weight-scale"
  friendly_name: "Weight Scale"

  # HX711 pins
  hx711_dout_pin: "GPIO4"
  hx711_sck_pin: "GPIO5"

  # Calibration value (adjust after calibration)
  # This is load_cell_reading / known_weight
  calibration_value: "2280"

  # Max capacity (for percentage calculation)
  max_weight: "5000"  # grams

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}

esp32:
  board: esp32dev
  framework:
    type: arduino

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  ap:
    ssid: "${device_name}-fallback"

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

logger:
  level: INFO

# =============================================================================
# Global Variables
# =============================================================================

globals:
  - id: tare_offset
    type: float
    restore_value: yes
    initial_value: '0.0'

  - id: calibration_factor
    type: float
    restore_value: yes
    initial_value: '${calibration_value}'

# =============================================================================
# HX711 Sensor
# =============================================================================

sensor:
  # Raw HX711 reading
  - platform: hx711
    name: "${friendly_name} Raw"
    id: weight_raw
    dout_pin: ${hx711_dout_pin}
    clk_pin: ${hx711_sck_pin}
    gain: 128
    update_interval: 500ms
    internal: true
    filters:
      - sliding_window_moving_average:
          window_size: 5
          send_every: 1

  # Calibrated weight in grams
  - platform: template
    name: "${friendly_name} Weight"
    id: weight_grams
    unit_of_measurement: "g"
    accuracy_decimals: 1
    device_class: weight
    icon: "mdi:scale"
    lambda: |-
      float raw = id(weight_raw).state;
      float weight = (raw - id(tare_offset)) / id(calibration_factor);
      return max(0.0f, weight);
    update_interval: 500ms

  # Weight in kilograms
  - platform: template
    name: "${friendly_name} Weight (kg)"
    unit_of_measurement: "kg"
    accuracy_decimals: 3
    device_class: weight
    lambda: return id(weight_grams).state / 1000.0;
    update_interval: 1s

  # Weight in pounds
  - platform: template
    name: "${friendly_name} Weight (lb)"
    unit_of_measurement: "lb"
    accuracy_decimals: 2
    device_class: weight
    lambda: return id(weight_grams).state / 453.592;
    update_interval: 1s

  # Weight in ounces
  - platform: template
    name: "${friendly_name} Weight (oz)"
    unit_of_measurement: "oz"
    accuracy_decimals: 1
    device_class: weight
    lambda: return id(weight_grams).state / 28.3495;
    update_interval: 1s

  # Capacity percentage
  - platform: template
    name: "${friendly_name} Capacity"
    unit_of_measurement: "%"
    icon: "mdi:percent"
    lambda: |-
      float pct = (id(weight_grams).state / ${max_weight}) * 100;
      return clamp(pct, 0.0f, 100.0f);
    update_interval: 1s

  # WiFi signal
  - platform: wifi_signal
    name: "${friendly_name} WiFi"
    update_interval: 60s
    entity_category: diagnostic

# =============================================================================
# Buttons
# =============================================================================

button:
  # Tare (zero) the scale
  - platform: template
    name: "${friendly_name} Tare"
    icon: "mdi:scale-balance"
    on_press:
      - lambda: |-
          id(tare_offset) = id(weight_raw).state;
          ESP_LOGI("scale", "Tare set to: %.2f", id(tare_offset));

  - platform: restart
    name: "${friendly_name} Restart"
    entity_category: config

# =============================================================================
# Calibration Numbers
# =============================================================================

number:
  # Calibration factor adjustment
  - platform: template
    name: "${friendly_name} Calibration Factor"
    id: cal_factor_input
    min_value: 100
    max_value: 10000
    step: 10
    initial_value: ${calibration_value}
    optimistic: true
    restore_value: true
    entity_category: config
    on_value:
      - lambda: id(calibration_factor) = x;

# =============================================================================
# Calibration Procedure (use with known weight)
# =============================================================================

# To calibrate:
# 1. Place scale on flat surface
# 2. Press "Tare" with empty scale
# 3. Place known weight (e.g., 1000g)
# 4. Note the raw reading from logs
# 5. Calculate: calibration_factor = raw_reading / known_weight
# 6. Update calibration_factor number entity
# 7. Verify with known weight

text_sensor:
  - platform: template
    name: "${friendly_name} Calibration Guide"
    lambda: |-
      return {"1. Tare empty, 2. Add known weight, 3. factor = raw / weight"};
    entity_category: diagnostic

  - platform: version
    name: "${friendly_name} ESPHome Version"
    entity_category: diagnostic

# =============================================================================
# Binary Sensors
# =============================================================================

binary_sensor:
  # Weight present (more than 10g)
  - platform: template
    name: "${friendly_name} Weight Present"
    device_class: occupancy
    lambda: return id(weight_grams).state > 10;

  - platform: status
    name: "${friendly_name} Status"

# =============================================================================
# Optional: OLED Display
# =============================================================================

# Uncomment for SSD1306 display
# i2c:
#   sda: GPIO21
#   scl: GPIO22
#
# display:
#   - platform: ssd1306_i2c
#     model: "SSD1306 128x64"
#     address: 0x3C
#     lambda: |-
#       it.printf(64, 10, id(font_large), TextAlign::TOP_CENTER, "%.1f g", id(weight_grams).state);
#       it.printf(64, 40, id(font_small), TextAlign::TOP_CENTER, "%.3f kg", id(weight_grams).state / 1000.0);
#
# font:
#   - file: "fonts/arial.ttf"
#     id: font_large
#     size: 24
#   - file: "fonts/arial.ttf"
#     id: font_small
#     size: 14
