# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# Air Quality Monitor
# -------------------
# Comprehensive indoor air quality monitoring with:
# - CO2 level (SCD40 or SGP30)
# - PM2.5/PM10 particulate matter (PMS7003)
# - Temperature & humidity (SHT31)
# - VOC/eCO2 optional (SGP30)
# - Status LED strip showing air quality
#
# Hardware:
#   - ESP32 DevKit or ESP32-S3
#   - SCD40 or SGP30 CO2/VOC sensor (I2C)
#   - PMS7003 or PMS5003 PM sensor (UART)
#   - SHT31 temperature/humidity (I2C)
#   - WS2812B LED strip (8 LEDs recommended)

substitutions:
  device_name: "air-quality-monitor"
  friendly_name: "Air Quality Monitor"
  room_name: "Living Room"

  # I2C pins
  sda_pin: "GPIO21"
  scl_pin: "GPIO22"

  # PMS sensor UART
  pms_tx_pin: "GPIO17"
  pms_rx_pin: "GPIO16"

  # Status LED
  led_pin: "GPIO48"
  num_leds: "8"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}

esp32:
  board: esp32dev
  framework:
    type: arduino

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  ap:
    ssid: "${device_name}-fallback"

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

logger:
  level: INFO

# =============================================================================
# I2C Bus
# =============================================================================

i2c:
  sda: ${sda_pin}
  scl: ${scl_pin}
  scan: true

# =============================================================================
# UART for PM Sensor
# =============================================================================

uart:
  id: uart_pms
  tx_pin: ${pms_tx_pin}
  rx_pin: ${pms_rx_pin}
  baud_rate: 9600

# =============================================================================
# Sensors
# =============================================================================

sensor:
  # CO2 Sensor (SCD40 - recommended)
  - platform: scd4x
    co2:
      name: "${room_name} CO2"
      id: co2_level
    temperature:
      name: "${room_name} Temperature (SCD40)"
      id: temp_scd40
    humidity:
      name: "${room_name} Humidity (SCD40)"
      id: humidity_scd40
    update_interval: 30s

  # Alternative: SGP30 for eCO2/TVOC
  # - platform: sgp30
  #   eco2:
  #     name: "${room_name} eCO2"
  #     accuracy_decimals: 0
  #   tvoc:
  #     name: "${room_name} TVOC"
  #     accuracy_decimals: 0
  #   compensation:
  #     temperature_source: temp_sht31
  #     humidity_source: humidity_sht31

  # Temperature & Humidity (SHT31)
  - platform: sht3xd
    temperature:
      name: "${room_name} Temperature"
      id: temp_sht31
    humidity:
      name: "${room_name} Humidity"
      id: humidity_sht31
    address: 0x44
    update_interval: 30s

  # Particulate Matter (PMS7003/PMS5003)
  - platform: pmsx003
    type: PMSX003
    uart_id: uart_pms
    pm_1_0:
      name: "${room_name} PM1.0"
    pm_2_5:
      name: "${room_name} PM2.5"
      id: pm25_level
    pm_10_0:
      name: "${room_name} PM10"
    update_interval: 60s

  # Air Quality Index (calculated)
  - platform: template
    name: "${room_name} AQI"
    id: aqi_value
    unit_of_measurement: "AQI"
    icon: "mdi:air-filter"
    lambda: |-
      float pm25 = id(pm25_level).state;
      float co2 = id(co2_level).state;

      // Simple AQI calculation based on PM2.5
      float aqi = 0;
      if (pm25 <= 12.0) aqi = pm25 * 50.0 / 12.0;
      else if (pm25 <= 35.4) aqi = 50 + (pm25 - 12.0) * 50.0 / 23.4;
      else if (pm25 <= 55.4) aqi = 100 + (pm25 - 35.4) * 50.0 / 20.0;
      else if (pm25 <= 150.4) aqi = 150 + (pm25 - 55.4) * 50.0 / 95.0;
      else aqi = 200 + (pm25 - 150.4) * 100.0 / 100.0;

      // Factor in CO2 (> 1000 ppm is concerning)
      if (co2 > 1000) aqi = max(aqi, (co2 - 1000) / 10.0 + 100);

      return aqi;
    update_interval: 60s

  # WiFi & System
  - platform: wifi_signal
    name: "${room_name} AQM WiFi"
    update_interval: 60s
    entity_category: diagnostic

  - platform: uptime
    name: "${room_name} AQM Uptime"
    entity_category: diagnostic

# =============================================================================
# Status LED Strip
# =============================================================================

light:
  - platform: esp32_rmt_led_strip
    id: status_leds
    name: "${room_name} AQI Status"
    pin: ${led_pin}
    num_leds: ${num_leds}
    rgb_order: GRB
    chipset: WS2812
    rmt_channel: 0

# Update LED color based on AQI
interval:
  - interval: 10s
    then:
      - lambda: |-
          float aqi = id(aqi_value).state;
          auto call = id(status_leds).turn_on();

          if (aqi < 50) {
            // Good - Green
            call.set_rgb(0.0, 1.0, 0.0);
          } else if (aqi < 100) {
            // Moderate - Yellow
            call.set_rgb(1.0, 1.0, 0.0);
          } else if (aqi < 150) {
            // Unhealthy for sensitive - Orange
            call.set_rgb(1.0, 0.5, 0.0);
          } else if (aqi < 200) {
            // Unhealthy - Red
            call.set_rgb(1.0, 0.0, 0.0);
          } else {
            // Very unhealthy - Purple
            call.set_rgb(0.5, 0.0, 0.5);
          }

          call.set_brightness(0.3);
          call.perform();

# =============================================================================
# Text Sensors
# =============================================================================

text_sensor:
  - platform: template
    name: "${room_name} Air Quality"
    lambda: |-
      float aqi = id(aqi_value).state;
      if (aqi < 50) return {"Good"};
      if (aqi < 100) return {"Moderate"};
      if (aqi < 150) return {"Unhealthy (Sensitive)"};
      if (aqi < 200) return {"Unhealthy"};
      return {"Very Unhealthy"};
    update_interval: 60s

  - platform: version
    name: "${room_name} AQM ESPHome Version"
    entity_category: diagnostic

# =============================================================================
# Binary Sensors
# =============================================================================

binary_sensor:
  - platform: template
    name: "${room_name} CO2 Warning"
    device_class: safety
    lambda: return id(co2_level).state > 1000;

  - platform: template
    name: "${room_name} PM2.5 Warning"
    device_class: safety
    lambda: return id(pm25_level).state > 35;

  - platform: status
    name: "${room_name} AQM Status"

# =============================================================================
# Buttons
# =============================================================================

button:
  - platform: restart
    name: "${room_name} AQM Restart"
    entity_category: config

  # Force SCD40 recalibration (outdoor fresh air)
  - platform: template
    name: "${room_name} Calibrate CO2"
    entity_category: config
    on_press:
      - scd4x.perform_forced_calibration:
          value: 420  # Current outdoor CO2 level
