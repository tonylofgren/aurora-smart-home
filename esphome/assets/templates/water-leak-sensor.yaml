# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# Water Leak Sensor
# -----------------
# Battery-powered water leak detector with:
# - Multiple leak detection points
# - Temperature monitoring
# - Critical alert on detection
# - Deep sleep for long battery life
#
# Hardware:
#   - ESP32-C3 Mini (low power)
#   - Water leak detection probes (simple wires)
#   - DS18B20 temperature sensor (optional)
#   - 18650 battery + TP4056 charger
#
# Placement: Under washing machine, dishwasher, water heater, sinks

substitutions:
  device_name: "water-leak-sensor"
  friendly_name: "Water Leak Sensor"
  location: "Laundry Room"

  # Leak detection pins (active low with pullup)
  leak_pin_1: "GPIO2"
  leak_pin_2: "GPIO3"
  leak_pin_3: "GPIO4"

  # Temperature sensor
  temp_pin: "GPIO5"

  # Battery monitoring
  battery_pin: "GPIO0"

  # Sleep duration (seconds) - wake every 5 minutes
  sleep_duration: "300s"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  on_boot:
    priority: -100
    then:
      # Check for leak immediately on boot
      - if:
          condition:
            or:
              - binary_sensor.is_on: leak_sensor_1
              - binary_sensor.is_on: leak_sensor_2
              - binary_sensor.is_on: leak_sensor_3
          then:
            # Leak detected - stay awake for alerts
            - logger.log: "LEAK DETECTED - Staying awake!"
          else:
            # No leak - go back to sleep
            - delay: 5s
            - deep_sleep.enter: deep_sleep_control

esp32:
  board: esp32-c3-devkitm-1
  framework:
    type: arduino

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  fast_connect: true

  ap:
    ssid: "${device_name}-fallback"

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

logger:
  level: INFO

# =============================================================================
# Deep Sleep Configuration
# =============================================================================

deep_sleep:
  id: deep_sleep_control
  run_duration: 10s
  sleep_duration: ${sleep_duration}
  # Wake on leak detection
  wakeup_pin:
    number: ${leak_pin_1}
    inverted: true
    mode: INPUT_PULLUP

# =============================================================================
# Leak Detection Sensors
# =============================================================================

binary_sensor:
  - platform: gpio
    pin:
      number: ${leak_pin_1}
      mode: INPUT_PULLUP
      inverted: true
    name: "${location} Leak Zone 1"
    id: leak_sensor_1
    device_class: moisture
    filters:
      - delayed_on: 100ms
    on_press:
      - logger.log: "Leak detected Zone 1!"
      - deep_sleep.prevent: deep_sleep_control

  - platform: gpio
    pin:
      number: ${leak_pin_2}
      mode: INPUT_PULLUP
      inverted: true
    name: "${location} Leak Zone 2"
    id: leak_sensor_2
    device_class: moisture
    filters:
      - delayed_on: 100ms
    on_press:
      - logger.log: "Leak detected Zone 2!"
      - deep_sleep.prevent: deep_sleep_control

  - platform: gpio
    pin:
      number: ${leak_pin_3}
      mode: INPUT_PULLUP
      inverted: true
    name: "${location} Leak Zone 3"
    id: leak_sensor_3
    device_class: moisture
    filters:
      - delayed_on: 100ms
    on_press:
      - logger.log: "Leak detected Zone 3!"
      - deep_sleep.prevent: deep_sleep_control

  # Combined leak status
  - platform: template
    name: "${location} Leak Detected"
    id: any_leak
    device_class: moisture
    lambda: |-
      return id(leak_sensor_1).state ||
             id(leak_sensor_2).state ||
             id(leak_sensor_3).state;

  - platform: status
    name: "${location} Leak Sensor Status"

# =============================================================================
# Temperature & Battery
# =============================================================================

# Dallas temperature sensor (optional)
# one_wire:
#   - platform: gpio
#     pin: ${temp_pin}

sensor:
  # Uncomment for DS18B20
  # - platform: dallas_temp
  #   address: 0x1234567890ABCDEF
  #   name: "${location} Temperature"
  #   update_interval: 60s

  # Battery voltage monitoring
  - platform: adc
    pin: ${battery_pin}
    name: "${location} Battery Voltage"
    id: battery_voltage
    attenuation: 11db
    filters:
      - multiply: 2.0  # Voltage divider ratio
    update_interval: 60s

  # Battery percentage
  - platform: template
    name: "${location} Battery"
    unit_of_measurement: "%"
    device_class: battery
    lambda: |-
      float voltage = id(battery_voltage).state;
      // LiPo: 4.2V = 100%, 3.0V = 0%
      float percentage = (voltage - 3.0) / (4.2 - 3.0) * 100;
      return clamp(percentage, 0.0f, 100.0f);
    update_interval: 60s

  - platform: wifi_signal
    name: "${location} Leak Sensor WiFi"
    update_interval: 60s
    entity_category: diagnostic

# =============================================================================
# Text Sensors
# =============================================================================

text_sensor:
  - platform: version
    name: "${location} Leak Sensor Version"
    entity_category: diagnostic

# =============================================================================
# Buttons
# =============================================================================

button:
  - platform: restart
    name: "${location} Leak Sensor Restart"
    entity_category: config

  # Manual wake (prevent sleep for maintenance)
  - platform: template
    name: "${location} Stay Awake"
    entity_category: config
    on_press:
      - deep_sleep.prevent: deep_sleep_control
      - logger.log: "Deep sleep prevented for maintenance"

  # Resume sleep
  - platform: template
    name: "${location} Resume Sleep"
    entity_category: config
    on_press:
      - deep_sleep.allow: deep_sleep_control
      - logger.log: "Deep sleep re-enabled"
