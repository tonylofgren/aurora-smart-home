# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# BLE Proxy Template
# ------------------
# Extends Home Assistant's Bluetooth range using ESP32 as proxy.
# Place multiple devices throughout your home for best coverage.
#
# Hardware: ESP32 (any variant with BLE support)
# Framework: ESP-IDF recommended for BLE stability
#
# Usage:
#   1. Change 'name' and 'friendly_name'
#   2. Update WiFi credentials in secrets.yaml
#   3. Optional: Enable static IP for reliability
#   4. Optional: Add local Xiaomi/BLE sensors

substitutions:
  name: "ble-proxy-room"
  friendly_name: "BLE Proxy Room"
  # For static IP (recommended)
  static_ip: ""  # e.g., "192.168.1.50"
  gateway: "192.168.1.1"
  subnet: "255.255.255.0"

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  # Recommended for BLE stability
  platformio_options:
    board_build.flash_mode: dio

esp32:
  board: esp32dev
  framework:
    type: esp-idf
    # Optimized settings for BLE
    sdkconfig_options:
      CONFIG_BT_BLE_50_FEATURES_SUPPORTED: y

# Optional: PSRAM if your board has it (ESP32-S3, etc.)
# psram:
#   mode: octal
#   speed: 80MHz

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  # Fast reconnection
  fast_connect: true
  # Power save off for reliability
  power_save_mode: none

  # Static IP - uncomment and set substitutions above
  # manual_ip:
  #   static_ip: ${static_ip}
  #   gateway: ${gateway}
  #   subnet: ${subnet}

  ap:
    ssid: "${name} Fallback"
    password: !secret ap_password

api:
  encryption:
    key: !secret api_encryption_key

ota:
  platform: esphome
  password: !secret ota_password

logger:
  level: WARN  # Reduce logging for performance
  # level: DEBUG  # Uncomment for troubleshooting

# BLE Tracker - scans for BLE devices
esp32_ble_tracker:
  scan_parameters:
    # Active scanning - required for some devices
    active: true
    # Scan interval and window - equal for continuous scanning
    interval: 1100ms
    window: 1100ms
    # Continuous mode for best detection
    continuous: true

# Bluetooth Proxy - forwards BLE to Home Assistant
bluetooth_proxy:
  # Enable active connections (required for most BLE devices)
  active: true
  # Cache GATT services for faster reconnection
  cache_services: true

# =============================================================================
# OPTIONAL: Local Xiaomi Sensors
# Uncomment and configure for sensors you want to read directly on this ESP32
# =============================================================================

# sensor:
#   # Xiaomi LYWSD03MMC (Temperature/Humidity)
#   - platform: xiaomi_lywsd03mmc
#     mac_address: "A4:C1:38:XX:XX:XX"
#     bindkey: "YOUR_BIND_KEY_HERE"
#     temperature:
#       name: "${friendly_name} Temperature"
#     humidity:
#       name: "${friendly_name} Humidity"
#     battery_level:
#       name: "${friendly_name} Battery"

#   # Xiaomi Mi Flora (Plant Sensor)
#   - platform: xiaomi_hhccjcy01
#     mac_address: "C4:7C:8D:XX:XX:XX"
#     temperature:
#       name: "Plant Temperature"
#     moisture:
#       name: "Plant Moisture"
#     illuminance:
#       name: "Plant Light"
#     conductivity:
#       name: "Plant Conductivity"
#     battery_level:
#       name: "Plant Sensor Battery"

# =============================================================================
# OPTIONAL: BLE Presence Detection
# Uncomment to detect specific BLE devices (phones, beacons, etc.)
# =============================================================================

# binary_sensor:
#   # iBeacon presence
#   - platform: ble_presence
#     ibeacon_uuid: "YOUR-IBEACON-UUID"
#     name: "iPhone Present"
#     device_class: presence

#   # MAC address presence (less reliable)
#   - platform: ble_presence
#     mac_address: "AA:BB:CC:DD:EE:FF"
#     name: "Smartwatch Present"
#     device_class: presence
#     timeout: 5min

# =============================================================================
# OPTIONAL: RSSI Sensor for distance estimation
# =============================================================================

# sensor:
#   - platform: ble_rssi
#     mac_address: "AA:BB:CC:DD:EE:FF"
#     name: "Phone RSSI"
#     filters:
#       - exponential_moving_average:
#           alpha: 0.3
#           send_every: 1

# =============================================================================
# Status LED (optional but helpful)
# =============================================================================

# For boards with built-in LED
status_led:
  pin:
    number: GPIO2
    inverted: false

# =============================================================================
# Diagnostic Sensors
# =============================================================================

sensor:
  - platform: wifi_signal
    name: "${friendly_name} WiFi Signal"
    update_interval: 60s

  - platform: uptime
    name: "${friendly_name} Uptime"
    update_interval: 60s

text_sensor:
  - platform: wifi_info
    ip_address:
      name: "${friendly_name} IP Address"
    mac_address:
      name: "${friendly_name} MAC Address"

button:
  - platform: restart
    name: "${friendly_name} Restart"
