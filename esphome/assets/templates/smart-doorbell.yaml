# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# Smart Doorbell with Camera
# --------------------------
# ESP32-CAM based video doorbell with:
# - Live video streaming
# - Motion detection (PIR)
# - Push button with notification
# - Two-way audio (optional)
# - LED indicator
#
# Hardware:
#   - ESP32-CAM (AI-Thinker or similar)
#   - PIR sensor (HC-SR501)
#   - Doorbell button
#   - Speaker + microphone (optional)
#   - 5V power supply (2A recommended)
#
# Note: This creates an MJPEG stream accessible via Home Assistant

substitutions:
  device_name: "smart-doorbell"
  friendly_name: "Smart Doorbell"

  # PIR sensor pin
  pir_pin: "GPIO13"

  # Doorbell button pin
  button_pin: "GPIO12"

  # Status LED (built-in on ESP32-CAM)
  led_pin: "GPIO33"

  # Flash LED (built-in on ESP32-CAM)
  flash_pin: "GPIO4"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}

esp32:
  board: esp32cam
  framework:
    type: arduino

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  ap:
    ssid: "${device_name}-fallback"

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

logger:
  level: INFO

# =============================================================================
# Camera Configuration
# =============================================================================

esp32_camera:
  name: "${friendly_name} Camera"
  id: doorbell_camera
  external_clock:
    pin: GPIO0
    frequency: 20MHz
  i2c_pins:
    sda: GPIO26
    scl: GPIO27
  data_pins: [GPIO5, GPIO18, GPIO19, GPIO21, GPIO36, GPIO39, GPIO34, GPIO35]
  vsync_pin: GPIO25
  href_pin: GPIO23
  pixel_clock_pin: GPIO22
  power_down_pin: GPIO32

  # Image settings
  resolution: 800x600
  jpeg_quality: 12
  vertical_flip: false
  horizontal_mirror: false

  # Frame rate (lower = less bandwidth)
  max_framerate: 15fps
  idle_framerate: 0.5fps

# Web server for camera stream
esp32_camera_web_server:
  - port: 8080
    mode: stream
  - port: 8081
    mode: snapshot

# =============================================================================
# Binary Sensors
# =============================================================================

binary_sensor:
  # Doorbell button
  - platform: gpio
    pin:
      number: ${button_pin}
      mode: INPUT_PULLUP
      inverted: true
    name: "${friendly_name} Button"
    device_class: doorbell
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    on_press:
      - logger.log: "Doorbell pressed!"
      # Flash LED briefly
      - output.turn_on: flash_led
      - delay: 500ms
      - output.turn_off: flash_led
      # Take snapshot
      - esp32_camera.request_image: doorbell_camera
      # Send event to Home Assistant
      - homeassistant.event:
          event: esphome.doorbell_pressed
          data:
            device: ${device_name}

  # PIR motion sensor
  - platform: gpio
    pin: ${pir_pin}
    name: "${friendly_name} Motion"
    device_class: motion
    filters:
      - delayed_off: 30s
    on_press:
      - logger.log: "Motion detected at doorbell"
      - homeassistant.event:
          event: esphome.doorbell_motion
          data:
            device: ${device_name}

  - platform: status
    name: "${friendly_name} Status"

# =============================================================================
# Outputs
# =============================================================================

output:
  # Flash LED (bright white LED on ESP32-CAM)
  - platform: gpio
    pin: ${flash_pin}
    id: flash_led

  # Status LED (red LED on ESP32-CAM)
  - platform: gpio
    pin:
      number: ${led_pin}
      inverted: true
    id: status_led

# =============================================================================
# Lights
# =============================================================================

light:
  # Controllable flash light
  - platform: binary
    name: "${friendly_name} Flash"
    output: flash_led
    icon: "mdi:flashlight"

  # Status indicator
  - platform: binary
    name: "${friendly_name} Status LED"
    output: status_led
    internal: true

# =============================================================================
# Sensors
# =============================================================================

sensor:
  - platform: wifi_signal
    name: "${friendly_name} WiFi"
    update_interval: 60s
    entity_category: diagnostic

  - platform: uptime
    name: "${friendly_name} Uptime"
    entity_category: diagnostic

# =============================================================================
# Text Sensors
# =============================================================================

text_sensor:
  - platform: wifi_info
    ip_address:
      name: "${friendly_name} IP"
      entity_category: diagnostic

  - platform: version
    name: "${friendly_name} ESPHome Version"
    entity_category: diagnostic

# =============================================================================
# Buttons
# =============================================================================

button:
  - platform: restart
    name: "${friendly_name} Restart"
    entity_category: config

  # Manual snapshot trigger
  - platform: template
    name: "${friendly_name} Take Snapshot"
    icon: "mdi:camera"
    on_press:
      - esp32_camera.request_image: doorbell_camera

# =============================================================================
# Status LED Blink on Boot
# =============================================================================

interval:
  - interval: 1s
    then:
      - if:
          condition:
            wifi.connected:
          then:
            - output.turn_on: status_led
          else:
            - output.turn_on: status_led
            - delay: 100ms
            - output.turn_off: status_led

# =============================================================================
# Home Assistant Integration Notes
# =============================================================================

# Camera stream URL: http://<device_ip>:8080/
# Snapshot URL: http://<device_ip>:8081/
#
# Example automation for doorbell notification:
#
# automation:
#   - alias: "Doorbell Notification"
#     trigger:
#       - platform: event
#         event_type: esphome.doorbell_pressed
#     action:
#       - service: camera.snapshot
#         target:
#           entity_id: camera.smart_doorbell_camera
#         data:
#           filename: "/config/www/doorbell_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"
#       - service: notify.mobile_app
#         data:
#           title: "Doorbell"
#           message: "Someone is at the door!"
#           data:
#             image: "/local/doorbell_latest.jpg"
